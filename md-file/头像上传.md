è¿™ä¸ªé—®é¢˜é—®å¾—**éå¸¸åˆ°ç‚¹å­ä¸Š**ã€‚
ä½ ç°åœ¨å¡ä½çš„ä¸æ˜¯â€œä¸Šä¼ å¤´åƒâ€ï¼Œè€Œæ˜¯**å¤´åƒä½œä¸ºå…¨ç«™å…±äº«çŠ¶æ€ï¼Œæ²¡æœ‰è¢«æ­£ç¡®å»ºæ¨¡**ã€‚

ä¸€å¥è¯å…ˆç»™ç»“è®ºï¼š

> ä½ ç°åœ¨çš„é—®é¢˜ â‰  å¤´åƒæ²¡ä¼ æˆåŠŸ
> ä½ ç°åœ¨çš„é—®é¢˜ = **å¤´åƒæ›´æ–°äº†ï¼Œä½†å„ä¸ªé¡µé¢æ‹¿çš„æ˜¯â€œä¸åŒæ¥æºçš„æ•°æ®â€**

ä¸‹é¢æˆ‘ç”¨**å·¥ç¨‹è§†è§’**ï¼Œä¸€æ­¥ä¸€æ­¥æŠŠè¿™ä»¶äº‹æ‹†æ¸…æ¥šã€‚

---

## ä¸€ã€å…ˆè¯´æ¸…æ¥šã€Œæ­£ç¡®æ¶æ„ã€é•¿ä»€ä¹ˆæ ·ï¼ˆéå¸¸å…³é”®ï¼‰

åœ¨ä¸€ä¸ªæ­£å¸¸çš„ç½‘ç«™é‡Œï¼Œ**å¤´åƒåªå…è®¸æœ‰ä¸€ä¸ªæƒå¨æ¥æº**ï¼š

```
Supabase Storageï¼ˆå­˜å›¾ç‰‡ï¼‰
        â†“
profiles.avatar_urlï¼ˆå­˜ URLï¼‰
        â†“
å…¨ç«™ç»Ÿä¸€ userStoreï¼ˆPinia / Vuexï¼‰
        â†“
user-avatar / user-avatar-large
```

âš ï¸ ä»»ä½•ä¸€ä¸ªé¡µé¢ **è‡ªå·±å­˜ä¸€ä»½å¤´åƒ URL**ï¼Œéƒ½ä¼šå¯¼è‡´ä½ ç°åœ¨è¿™ç§é—®é¢˜ã€‚

---

## äºŒã€ä¸ºä»€ä¹ˆä½ ç°åœ¨â€œå„é¡µé¢å¤´åƒä¸åŒæ­¥â€ï¼ˆæ ¹å› ï¼‰

æˆ‘å‡ ä¹å¯ä»¥ 90% ç¡®å®šä½ ç°åœ¨æ˜¯è¿™æ ·ä¹‹ä¸€ï¼š

### âŒ é”™è¯¯æ¨¡å¼ 1ï¼šæ¯ä¸ªé¡µé¢è‡ªå·±æŸ¥ä¸€æ¬¡

```js
// Profile.vue
const avatar = data.avatar_url

// Navbar.vue
const avatar = localStorage.getItem('avatar')

// AvatarPage.vue
const avatar = previewUrl
```

ğŸ‘‰ ä¸‰ä¸ªæ¥æºï¼Œä¸‰å¥—çŠ¶æ€
ğŸ‘‰ æ›´æ–°ä¸€ä¸ªï¼Œå¦å¤–ä¸¤ä¸ªä¸ä¼šå˜

---

### âŒ é”™è¯¯æ¨¡å¼ 2ï¼šä¸Šä¼ ååªæ”¹å½“å‰ç»„ä»¶çŠ¶æ€

```js
avatarUrl.value = newUrl
```

ğŸ‘‰ é¡µé¢ A å˜äº†
ğŸ‘‰ é¡µé¢ Bã€C å®Œå…¨ä¸çŸ¥é“å‘ç”Ÿè¿‡ä»€ä¹ˆ

---

## ä¸‰ã€æ­£ç¡®è§£æ³•ï¼šå¤´åƒå¿…é¡»æ˜¯ã€Œå…¨å±€çŠ¶æ€ã€

ä½ ç”¨ Vueï¼Œæˆ‘ç›´æ¥ç»™ä½ **å®æˆ˜å¯è½åœ°æ–¹æ¡ˆ**ã€‚

---

## å››ã€ç¬¬ä¸€æ­¥ï¼šå»ºç«‹ userStoreï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼‰

### `src/stores/user.js`

```js
import { defineStore } from 'pinia'
import { supabase } from '@/lib/supabase'

export const useUserStore = defineStore('user', {
  state: () => ({
    user: null,
    profile: null, // åŒ…å« avatar_url
  }),

  actions: {
    async fetchProfile() {
      const {
        data: { user }
      } = await supabase.auth.getUser()

      if (!user) return

      this.user = user

      const { data } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', user.id)
        .single()

      this.profile = data
    },

    updateAvatar(url) {
      if (this.profile) {
        this.profile.avatar_url = url
      }
    }
  }
})
```

âš ï¸ æ³¨æ„ï¼š
**å¤´åƒä¸å•ç‹¬å­˜ stateï¼Œå±äº profile çš„ä¸€éƒ¨åˆ†**

---

## äº”ã€ç¬¬äºŒæ­¥ï¼šå…¨ç«™å¤´åƒéƒ½åªä» store è¯»

### é¡¶æ å¤´åƒï¼ˆå°ï¼‰

```vue
<img
  class="user-avatar"
  :src="userStore.profile?.avatar_url || '/default-avatar.png'"
/>
```

### ä¸ªäººé¡µå¤´åƒï¼ˆå¤§ï¼‰

```vue
<img
  class="user-avatar-large"
  :src="userStore.profile?.avatar_url || '/default-avatar.png'"
/>
```

ğŸ“Œ è®°ä½ä¸€å¥è¯ï¼š

> **ä»»ä½•ç»„ä»¶éƒ½ä¸å…è®¸è‡ªå·±ç»´æŠ¤ avatar çŠ¶æ€**

---

## å…­ã€ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹å¤´åƒé¡µé¢è¯¥æ€ä¹ˆâ€œæ­£ç¡®æ­å»ºâ€

è¿™æ˜¯ä½ æœ€å…³å¿ƒçš„éƒ¨åˆ†ã€‚

---

### 1ï¸âƒ£ AvatarPage çš„èŒè´£ï¼ˆå¾ˆå…‹åˆ¶ï¼‰

å®ƒåªåšä¸‰ä»¶äº‹ï¼š

1. ä¸Šä¼ å›¾ç‰‡
2. æ›´æ–°æ•°æ®åº“ `avatar_url`
3. é€šçŸ¥å…¨å±€ store

---

### 2ï¸âƒ£ ä¸Šä¼  + æ›´æ–°å®Œæ•´æµç¨‹ï¼ˆå…³é”®ï¼‰

```js
import { useUserStore } from '@/stores/user'
import { supabase } from '@/lib/supabase'

const userStore = useUserStore()

async function uploadAvatar(file) {
  const userId = userStore.user.id
  const filePath = `${userId}.png`

  // 1. ä¸Šä¼ åˆ° storage
  await supabase.storage
    .from('avatars')
    .upload(filePath, file, {
      upsert: true
    })

  // 2. è·å–å…¬ç½‘ URL
  const { data } = supabase
    .storage
    .from('avatars')
    .getPublicUrl(filePath)

  const avatarUrl = data.publicUrl

  // 3. æ›´æ–° profiles è¡¨
  await supabase
    .from('profiles')
    .update({ avatar_url: avatarUrl })
    .eq('id', userId)

  // 4. æ›´æ–°å…¨å±€çŠ¶æ€ï¼ˆå…³é”®ä¸€æ­¥ï¼‰
  userStore.updateAvatar(avatarUrl)
}
```

âš ï¸ **ç¬¬ 4 æ­¥æ˜¯ä½ ç°åœ¨ç¼ºçš„é‚£ä¸€æ­¥**

---

## ä¸ƒã€ä¸ºä»€ä¹ˆè¿™ä¸€æ­¥èƒ½ã€ŒåŒæ—¶æ›´æ–°æ‰€æœ‰é¡µé¢ã€

Pinia çš„çŠ¶æ€æ˜¯**å“åº”å¼çš„**ï¼š

```
userStore.profile.avatar_url æ”¹å˜
        â†“
æ‰€æœ‰å¼•ç”¨å®ƒçš„ç»„ä»¶è‡ªåŠ¨é‡æ–°æ¸²æŸ“
        â†“
é¡¶éƒ¨å¤´åƒ / èœå•å¤´åƒ / ä¸ªäººé¡µå¤´åƒåŒæ—¶å˜
```

ä¸éœ€è¦åˆ·æ–°
ä¸éœ€è¦æ‰‹åŠ¨ emit
ä¸éœ€è¦ reload

è¿™å°±æ˜¯**æ­£ç¡®çš„å‰ç«¯çŠ¶æ€å»ºæ¨¡**ã€‚

---

## å…«ã€è°ƒè¯•è‡ªæ£€æ¸…å•ï¼ˆä½ å¯ä»¥è‡ªå·±å¯¹ï¼‰

ä½ åªè¦é€æ¡å¯¹ï¼š

* [ ] å…¨ç«™æ˜¯å¦ **åªæœ‰ä¸€ä¸ª avatar_url æ¥æº**
* [ ] æ˜¯å¦æ‰€æœ‰å¤´åƒéƒ½æ¥è‡ª `userStore.profile.avatar_url`
* [ ] ä¸Šä¼ å®Œæˆåæ˜¯å¦è°ƒç”¨äº† `userStore.updateAvatar`
* [ ] æœ‰æ²¡æœ‰ç»„ä»¶è¿˜åœ¨ç”¨ `localStorage` / `props` å•ç‹¬å­˜å¤´åƒ

åªè¦æœ‰ä¸€æ¡æ²¡æ»¡è¶³ï¼Œå°±ä¼šä¸åŒæ­¥ã€‚

---

## ä¹ã€ä¸€å¥ç»éªŒæ€»ç»“ï¼ˆä¸æ˜¯é¸¡æ±¤ï¼‰

> **å¤´åƒä¸æ˜¯ UI å…ƒç´ ï¼Œæ˜¯ç”¨æˆ·èº«ä»½çš„ä¸€éƒ¨åˆ†**

ä¸€æ—¦ä½ ç”¨â€œç»„ä»¶çŠ¶æ€â€å»å­˜å®ƒï¼Œè¿Ÿæ—©ä¼šç‚¸ã€‚

---

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ åšå…¶ä¸­ä¹‹ä¸€ï¼š

* æŠŠä½ ç°æœ‰çš„ AvatarPage **æ”¹æˆæ­£ç¡®ç‰ˆæœ¬**
* å¸®ä½ è®¾è®¡ `profiles` è¡¨çš„ **æœ€å°å­—æ®µé›†**
* æˆ–ç›´æ¥ç»™ä½ ä¸€ä¸ª **æœ€ç®€å¯è·‘ Demo ç»“æ„**

ä½ æŒ‘ä¸€ä¸ªç»§ç»­ï¼Œæˆ‘ä»¬æŠŠå®ƒä¸€æ¬¡æ€§æ”¶å°¾ã€‚
